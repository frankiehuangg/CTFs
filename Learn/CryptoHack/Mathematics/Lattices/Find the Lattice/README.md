# Find the Lattice

## Description

As a hint, you will be able to break this challenge using the Gaussian reduction from the previous challenge.

**Challenge files:**\
\- [source.py](https://cryptohack.org/static/challenges/source\_ca1901b901faf91d690cb35998d0b80e.py)\
\- [output.txt](https://cryptohack.org/static/challenges/output\_bc9603ab4045eea70eae450862d4be91.txt)

## Solution
Looking at the provided code, we find that the cryptosystem uses the public keypair $(q,h)$ and the private keypair $(f,g)$ to encrypt message $m$ and decrypt cipher $e$.

#### Public and Private Keypair Generation

Firstly, the public and private keypair is generated by

$$
q = a\ 512\ bit\ prime\ integer
$$

$$
2 \leq f < \sqrt{\frac{q}{2}}\ \ and\ \ \sqrt{\frac{q}{4}} \leq g < \sqrt{\frac{q}{2}} \quad\quad (1)
$$

Where $f$ and $g$ satisfies

$$
gcd(f, g) = 1
$$

Finally, $h$ is generated by

$$
h \equiv f^{-1}g\ (mod\ q) \quad\quad (2)
$$

#### Encryption

To encrypt a message $m$, the value $m$ must satisfies

$$
m < \sqrt{\frac{q}{2}} \quad\quad (3)
$$

Then, the ciphertext $e$ is generated firstly by finding an integer r that satisfies

$$
2 \leq r < \sqrt{\frac{q}{2}} \quad\quad (4)
$$

Finally,

$$
e \equiv rh + m\ (mod\ q) \quad\quad (5)
$$

#### Decryption

To decrypt the ciphertext $e$, we first calculate the value $a$, where

$$
a \equiv fe\ (mod\ q) \quad\quad (6)
$$

Finally, we calculate $b$, where

$$
b \equiv f^{-1} a\ (mod\ g) \quad\quad (7)
$$

#### Proof

We will prove that $b \equiv m$. We can substitute $(5)$ into $(6)$

$$
a \equiv f(rh + m)\ (mod\ q) \quad\quad (8)
$$

Then, we substitute $(2)$ into $(8)$

$$
a \equiv f(rf^{-1}g + m)\ (mod\ q)
$$

$$
a \equiv frf^{-1}g + fm\ (mod\ q)
$$

$$
a \equiv rg + fm\ (mod\ q)
$$

Then, we will prove that $$a = rg + fm$$ from $(1)$, $(3)$, and $(4)$

$$
rg + fm < \sqrt{\frac{q}{2}} \sqrt{\frac{q}{2}} + \sqrt{\frac{q}{2}} \sqrt{\frac{q}{2}}
$$

$$
rg + fm < \frac{q}{2} + \frac{q}{2}
$$

$$
rg + fm < q
$$

Because the value of $rg + fm$ is less than q, then

$$
a = rg + fm \quad\quad (9)
$$

Now, we will prove that $b \equiv m$ from $(7)$ and $(9)$

$$
b \equiv f^{-1}(rg+fm)\ (mod\ g)
$$

$$
b \equiv f^{-1}rg + f^{-1}fm)\ (mod\ g) \quad\quad (10)
$$

Since $f^{-1}rg \ (mod\ g) \equiv 0$, we can rewrite (10) into

$$
b \equiv f^{-1}fm\ (mod\ g)
$$

$$
b \equiv m\ (mod\ g)
$$

#### Attack

From the provided `output.txt` file, we have the public keypair $(q, h)$. To attack this cryptosystem, we need to find the private keypair $(f, g)$. From $(2)$, we know that

$$
h \equiv f^{-1}g\ (mod\ q)
$$

Then, we need to find a pair of integer $(F, G)$ where

$$
Fh \equiv G\ (mod\ q) \quad\quad (11)
$$

That satisfies

$$
Ff^{-1}g \equiv G\ (mod\ q)
$$

$$
g \equiv G\ (mod\ q)
$$

$$
(F, G) = (f, g)
$$

Rewriting $(11)$, we get

$$
Fh = G + qR
$$

$$
G = Fh - qR \quad\quad (12)
$$

Then, we can find the value $(F,G)$ by turning $(12)$ into a vector notation

$$
(F, G) = F(1, h) - R(0, q)
$$

Thus, we get the vector $v_1 = (1,h)$ and $v_2 = (0, q)$. Finally, we need to find the integer $a_1$ and $a_2$, such that

$$
w = a_1v_1 + a_2v_2 \quad\quad a_1,a_2 \in \mathbb{Z}, w \leq q
$$

#### Solving the challenge

For this challenge, i used sage to find the value $f$ and $g$, and python to decrypt the ciphertext. First we must make the vectors $v_1$ and $v_2$.

```python
v1 = vector([1, h])
v2 = vector([0, q])
```

Next, we find the basis vector using the gaussian lattice reduction algorithm

```python
def gaussian(v1, v2):
	while (True):
		if (v2.norm() < v1.norm()):
			v1, v2 = v2, v1

		m = round((v1 * v2) / (v1.norm()^2))

		if (m == 0):
			return v1, v2
		
		v2 = v2 - m * v1

l1, l2 = gaussian(v1, v2)
```

Since $(F, G)$ is either $l_1$ or $l_2$, we just need to check both possibility. Since $l_2 > \sqrt{\frac{q}{2}}$, we know that $l_1$ is the pair.

Finally, to decrypt the ciphertext, we call the function `decrypt` and change it into bytes with `long_to_bytes`

```python
def decrypt(q, h, f, g, e):
    a = (f*e) % q
    m = (a*inverse(f, g)) % g
    return m

print(long_to_bytes(decrypt(q, h, f, g, e)))
```

## Flag

```txt
crypto{Gauss_lattice_attack!}
```
